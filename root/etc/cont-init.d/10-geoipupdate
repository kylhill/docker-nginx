#!/usr/bin/with-contenv bash
set -e

read_secret() {
  var="$1"
  file_var="${var}_FILE"

  if [ -n "${!file_var}" ] && [ -f "${!file_var}" ]; then
    cat "${!file_var}"
  else
    echo "${!var}"
  fi
}

ACCOUNT_ID="$(read_secret GEOIPUPDATE_ACCOUNT_ID)"
LICENSE_KEY="$(read_secret GEOIPUPDATE_LICENSE_KEY)"

if [[ -n "$ACCOUNT_ID" && -n "$LICENSE_KEY" ]]; then
  echo "Configuring GeoIPUpdate..."

  mkdir -p /config/geoip

  cat > /etc/GeoIP.conf <<EOF
AccountID ${ACCOUNT_ID}
LicenseKey ${LICENSE_KEY}
EditionIDs ${GEOIPUPDATE_EDITION_IDS}
EOF

  echo "Running geoipupdate..."
  /usr/local/bin/geoipupdate -f /etc/GeoIP.conf -d /config/geoip
else
  echo "GeoIPUpdate credentials not set, skipping update."
fi
